@using CapaModelo
@{
    ViewBag.Title = "Asignación de Roles a Personas";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* Estilos para las tablas de asignación */
    .assignment-container {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        margin-top: 20px;
    }

    .assignment-table-container {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        background-color: #fff;
    }

    .table-left {
        border-color: #e74c3c;
    }

    .table-right {
        border-color: #27ae60;
    }

    .table-header {
        color: #fff;
        padding: 10px;
        border-radius: 3px;
        margin: -15px -15px 15px -15px;
    }

    .header-left {
        background-color: #e74c3c;
    }

    .header-right {
        background-color: #27ae60;
    }

    .button-center {
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 10px;
        padding: 0 10px;
    }

    .move-button {
        min-width: 120px;
        white-space: nowrap;
    }

    .person-count {
        background-color: #fff !important;
        color: #dc3545 !important;
        border: 1px solid #dc3545 !important;
        border-radius: 12px !important;
        padding: 3px 8px !important;
        font-size: 0.8rem !important;
        font-weight: bold !important;
        margin-left: 10px !important;
    }

    .table-right .person-count {
        color: #198754 !important;
        border-color: #198754 !important;
    }

    .info-panel {
        background-color: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
    }

    /* Estilos para botones de confirmación */
    .confirm-dialog {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.5);
        z-index: 1000;
        display: none;
        justify-content: center;
        align-items: center;
    }

    .confirm-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    /* Estilos para notificaciones */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        display: none;
    }

    .person-info {
        cursor: pointer;
        transition: background-color 0.2s;
    }

        .person-info:hover {
            background-color: #f8f9fa;
        }

    .detail-badge {
        font-size: 0.7rem;
        margin-left: 5px;
        vertical-align: middle;
    }
</style>

<div class="container mt-3">
    <h3 class="mb-3"><i class="fas fa-users me-2"></i>Asignación de Roles a Personas</h3>

    <!-- Mensajes de éxito/error -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Notificación dinámica -->
    <div id="notification" class="notification alert" role="alert">
        <div class="d-flex justify-content-between align-items-center">
            <span id="notificationMessage"></span>
            <button type="button" class="btn-close" onclick="$('#notification').fadeOut()"></button>
        </div>
    </div>

    <!-- Diálogo de confirmación -->
    <div id="confirmDialog" class="confirm-dialog">
        <div class="confirm-content">
            <h5 id="confirmTitle" class="mb-3"><i class="fas fa-question-circle me-2"></i>Confirmar Acción</h5>
            <p id="confirmMessage"></p>
            <div class="d-flex justify-content-end gap-2 mt-4">
                <button type="button" class="btn btn-secondary" onclick="closeConfirm()">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmActionBtn">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Formulario principal -->
    <div id="formAsignacion">
        @Html.AntiForgeryToken()

        
        <!-- Selección de Rol -->
        <div class="mb-4">
            <label class="form-label fw-bold">Seleccionar Rol:</label>
            <div class="input-group" style="max-width: 400px;">
                @Html.DropDownList("rolId", ViewBag.Roles as SelectList ?? new SelectList(new List<Rol>()),
                "-- Seleccione un rol --",
                new { @class = "form-select", id = "rolSelect", required = "required" })
                <button type="button" id="btnCargarPersonas" class="btn btn-primary">
                    <i class="fas fa-sync me-1"></i>Cargar
                </button>
            </div>
        </div>

        <!-- Panel de información del rol (se muestra dinámicamente) -->
        <div id="infoPanel" class="info-panel" style="display: none;">
            <h5><i class="fas fa-info-circle me-2"></i>Información del Rol</h5>
            <div class="row mt-3">
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4">Código:</dt>
                        <dd class="col-sm-8" id="infoRolCodigo"></dd>

                        <dt class="col-sm-4">Nombre:</dt>
                        <dd class="col-sm-8" id="infoRolNombre"></dd>

                        <dt class="col-sm-4">Descripción:</dt>
                        <dd class="col-sm-8" id="infoRolDescripcion"></dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4">Estadísticas:</dt>
                        <dd class="col-sm-8">
                            <div>
                                <span class="badge bg-danger" id="countSinRol">0</span> Personas sin rol
                            </div>
                            <div class="mt-1">
                                <span class="badge bg-success" id="countConRol">0</span> Personas con este rol
                            </div>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Contenedor de asignación (se muestra dinámicamente) -->
        <div id="assignmentContainer" style="display: none;">

            <div class="assignment-container">
                <!-- Tabla izquierda: Personas SIN rol -->
                <div class="assignment-table-container table-left">
                    <div class="table-header header-left">
                        <h5 class="mb-0">
                            <i class="fas fa-user-times me-2"></i>Personas SIN rol
                            <span id="totalSinRol" class="person-count">0</span>
                        </h5>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover" id="tableSinRol">
                            <thead>
                                <tr>
                                    <th style="width:50px">
                                        <input type="checkbox" id="selectAllSinRol" />
                                    </th>
                                    <th>Código</th>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="tbodySinRol">
                                <!-- Las personas se cargarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Botones centrales -->
                <div class="button-center">
                    <button type="button" id="btnAsignar" class="btn btn-success move-button" disabled>
                        <i class="fas fa-arrow-right me-1"></i>Asignar
                    </button>
                    <button type="button" id="btnQuitar" class="btn btn-warning move-button" disabled>
                        <i class="fas fa-arrow-left me-1"></i>Quitar
                    </button>
                    <button type="button" id="btnAsignarInmediato" class="btn btn-success move-button" disabled style="margin-top: 10px;">
                        <i class="fas fa-check me-1"></i>Asignar (BD)
                    </button>
                    <button type="button" id="btnQuitarInmediato" class="btn btn-warning move-button" disabled>
                        <i class="fas fa-times me-1"></i>Quitar (BD)
                    </button>
                </div>

                <!-- Tabla derecha: Personas CON rol -->
                <div class="assignment-table-container table-right">
                    <div class="table-header header-right">
                        <h5 class="mb-0">
                            <i class="fas fa-user-check me-2"></i>Personas CON este rol
                            <span id="totalConRol" class="person-count">0</span>
                        </h5>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover" id="tableConRol">
                            <thead>
                                <tr>
                                    <th style="width:50px">
                                        <input type="checkbox" id="selectAllConRol" />
                                    </th>
                                    <th>Código</th>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyConRol">
                                <!-- Las personas se cargarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Instrucciones -->
            <div class="text-center mt-3 text-muted fst-italic">
                <i class="fas fa-mouse-pointer me-1"></i>
                Seleccione personas y use los botones para asignar/quitar el rol
            </div>

            <!-- Botones de acción -->
            <div class="mt-4 text-center">
                <button type="button" id="btnGuardar" class="btn btn-primary" style="min-width: 200px;">
                    <i class="fas fa-save me-1"></i>Guardar Todos los Cambios
                </button>
                <button type="button" id="btnLimpiar" class="btn btn-secondary" style="min-width: 200px;">
                    <i class="fas fa-refresh me-1"></i>Limpiar Selección
                </button>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            var rolSeleccionadoId = '';
            var rolSeleccionadoCodigo = '';
            var personasSinRol = [];
            var personasConRol = [];
            var personasSeleccionadasSinRol = [];
            var personasSeleccionadasConRol = [];

            // Función para mostrar notificación
            function showNotification(message, type) {
                var notification = $('#notification');
                var notificationMessage = $('#notificationMessage');

                notification.removeClass('alert-success alert-danger alert-warning alert-info');
                notification.addClass('alert-' + type);
                notificationMessage.text(message);

                notification.fadeIn();
                setTimeout(function() {
                    notification.fadeOut();
                }, 5000);
            }

            // Función para mostrar diálogo de confirmación
            function showConfirm(title, message, action) {
                $('#confirmTitle').text(title);
                $('#confirmMessage').text(message);
                $('#confirmActionBtn').off('click').on('click', action);
                $('#confirmDialog').fadeIn();
            }

            function closeConfirm() {
                $('#confirmDialog').fadeOut();
            }

            // Cargar personas cuando se selecciona un rol
            $('#btnCargarPersonas').on('click', function () {
                rolSeleccionadoId = $('#rolSelect').val();
                if (!rolSeleccionadoId) {
                    showNotification('Por favor, seleccione un rol', 'warning');
                    return;
                }

                console.log('=== Cargando personas para rol ID: ' + rolSeleccionadoId + ' ===');

                $.ajax({
                    url: '@Url.Action("PersonasConRol", "ControladorRol")',
                    type: 'GET',
                    data: { rolId: rolSeleccionadoId },
                    beforeSend: function () {
                        $('#btnCargarPersonas').prop('disabled', true)
                            .html('<i class="fas fa-spinner fa-spin me-1"></i>Cargando...');
                        $('#tbodySinRol, #tbodyConRol').html('<tr><td colspan="5" class="text-center">Cargando...</td></tr>');
                    },
                    success: function (response) {
                        if (response.success) {
                            // Obtener personas sin rol
                            $.ajax({
                                url: '@Url.Action("PersonasSinRol", "ControladorRol")',
                                type: 'GET',
                                success: function (responseSinRol) {
                                    if (responseSinRol.success) {
                                        // Mostrar información del rol
                                        $('#infoRolCodigo').text(response.rol.codigo);
                                        $('#infoRolNombre').text(response.rol.nombre);
                                        $('#infoRolDescripcion').text(response.rol.descripcion || 'Sin descripción');
                                        $('#infoPanel').show();

                                        // Guardar código del rol
                                        rolSeleccionadoCodigo = response.rol.codigo;

                                        // Guardar datos
                                        personasSinRol = responseSinRol.personas || [];
                                        personasConRol = response.personas || [];

                                        // Actualizar estadísticas
                                        $('#countSinRol').text(personasSinRol.length);
                                        $('#countConRol').text(personasConRol.length);
                                        $('#totalSinRol').text(personasSinRol.length);
                                        $('#totalConRol').text(personasConRol.length);

                                        // Renderizar tablas
                                        renderizarTablaSinRol();
                                        renderizarTablaConRol();

                                        // Mostrar contenedor de asignación
                                        $('#assignmentContainer').show();

                                        console.log('✅ Personas cargadas exitosamente');
                                        console.log('Personas sin rol: ' + personasSinRol.length);
                                        console.log('Personas con rol: ' + personasConRol.length);

                                        showNotification('Personas cargadas correctamente', 'success');
                                    } else {
                                        showNotification('Error al cargar personas sin rol: ' + responseSinRol.message, 'danger');
                                    }
                                },
                                error: function () {
                                    showNotification('Error al conectar con el servidor', 'danger');
                                }
                            });
                        } else {
                            showNotification('Error: ' + response.message, 'danger');
                            $('#infoPanel').hide();
                            $('#assignmentContainer').hide();
                        }
                    },
                    error: function (xhr, status, error) {
                        showNotification('Error al conectar con el servidor: ' + error, 'danger');
                    },
                    complete: function () {
                        $('#btnCargarPersonas').prop('disabled', false)
                            .html('<i class="fas fa-sync me-1"></i>Cargar');
                    }
                });
            });

            // Renderizar tabla de personas SIN rol
            function renderizarTablaSinRol() {
                var tbody = $('#tbodySinRol');
                tbody.empty();

                personasSinRol.forEach(function (persona) {
                    var row = $('<tr>').attr('data-id', persona.id).addClass('person-info');
                    row.append($('<td>').html('<input type="checkbox" class="person-checkbox" data-type="sinrol" value="' + persona.id + '">'));
                    row.append($('<td>').text(persona.codigo));
                    row.append($('<td>').html(persona.nombres + ' ' + persona.apellidos));
                    row.append($('<td>').text(persona.email));
                    row.append($('<td>').html('<span class="badge bg-' + (persona.estado === 'ACTIVO' ? 'success' : 'secondary') + '">' + (persona.estado || 'N/A') + '</span>'));
                    tbody.append(row);
                });

                // Si no hay personas
                if (personasSinRol.length === 0) {
                    tbody.append($('<tr>').append($('<td colspan="5" class="text-center">').text('No hay personas sin rol')));
                }
            }

            // Renderizar tabla de personas CON rol
            function renderizarTablaConRol() {
                var tbody = $('#tbodyConRol');
                tbody.empty();

                personasConRol.forEach(function (persona) {
                    var row = $('<tr>').attr('data-id', persona.id).addClass('person-info');
                    row.append($('<td>').html('<input type="checkbox" class="person-checkbox" data-type="conrol" value="' + persona.id + '">'));
                    row.append($('<td>').text(persona.codigo));
                    row.append($('<td>').html(persona.nombres + ' ' + persona.apellidos));
                    row.append($('<td>').text(persona.email));
                    row.append($('<td>').html('<span class="badge bg-' + (persona.estado === 'ACTIVO' ? 'success' : 'secondary') + '">' + (persona.estado || 'N/A') + '</span>'));
                    tbody.append(row);
                });

                // Si no hay personas
                if (personasConRol.length === 0) {
                    tbody.append($('<tr>').append($('<td colspan="5" class="text-center">').text('No hay personas con este rol')));
                }
            }

            // Seleccionar/deseleccionar todos (tabla izquierda)
            $('#selectAllSinRol').on('change', function () {
                var checked = $(this).prop('checked');
                $('#tbodySinRol input[data-type="sinrol"]').prop('checked', checked);
                actualizarSelecciones();
            });

            // Seleccionar/deseleccionar todos (tabla derecha)
            $('#selectAllConRol').on('change', function () {
                var checked = $(this).prop('checked');
                $('#tbodyConRol input[data-type="conrol"]').prop('checked', checked);
                actualizarSelecciones();
            });

            // Actualizar selecciones cuando se hace clic en un checkbox
            $(document).on('change', '.person-checkbox', function () {
                actualizarSelecciones();
            });

            // Hacer clic en fila para seleccionar/deseleccionar
            $(document).on('click', '.person-info', function (e) {
                if (!$(e.target).is('input[type="checkbox"]')) {
                    var checkbox = $(this).find('input[type="checkbox"]');
                    checkbox.prop('checked', !checkbox.prop('checked'));
                    actualizarSelecciones();
                }
            });

            function actualizarSelecciones() {
                personasSeleccionadasSinRol = [];
                personasSeleccionadasConRol = [];

                // Obtener personas seleccionadas sin rol
                $('#tbodySinRol input[data-type="sinrol"]:checked').each(function () {
                    personasSeleccionadasSinRol.push($(this).val());
                });

                // Obtener personas seleccionadas con rol
                $('#tbodyConRol input[data-type="conrol"]:checked').each(function () {
                    personasSeleccionadasConRol.push($(this).val());
                });

                // Habilitar/deshabilitar botones
                $('#btnAsignar').prop('disabled', personasSeleccionadasSinRol.length === 0);
                $('#btnQuitar').prop('disabled', personasSeleccionadasConRol.length === 0);
                $('#btnAsignarInmediato').prop('disabled', personasSeleccionadasSinRol.length === 0);
                $('#btnQuitarInmediato').prop('disabled', personasSeleccionadasConRol.length === 0);

                // Actualizar checkboxes "seleccionar todos"
                $('#selectAllSinRol').prop('checked',
                    personasSeleccionadasSinRol.length > 0 &&
                    personasSeleccionadasSinRol.length === personasSinRol.length);

                $('#selectAllConRol').prop('checked',
                    personasSeleccionadasConRol.length > 0 &&
                    personasSeleccionadasConRol.length === personasConRol.length);
            }

            // Botón "Asignar" - mover localmente (solo en la vista)
            $('#btnAsignar').on('click', function () {
                if (personasSeleccionadasSinRol.length === 0) {
                    showNotification('Seleccione personas para asignar', 'warning');
                    return;
                }

                // Verificar cada persona antes de mover
                var personasParaMover = [];
                var personasConRolExistente = [];

                personasSeleccionadasSinRol.forEach(function (personaId) {
                    var persona = personasSinRol.find(p => p.id === personaId);
                    if (persona) {
                        personasParaMover.push(persona);
                    }
                });

                // Mover personas localmente
                personasParaMover.forEach(function (persona) {
                    // Quitar de sin rol
                    personasSinRol = personasSinRol.filter(p => p.id !== persona.id);
                    // Agregar a con rol
                    personasConRol.push(persona);
                });

                // Actualizar tablas
                renderizarTablaSinRol();
                renderizarTablaConRol();

                // Actualizar estadísticas
                $('#totalSinRol').text(personasSinRol.length);
                $('#totalConRol').text(personasConRol.length);
                $('#countSinRol').text(personasSinRol.length);
                $('#countConRol').text(personasConRol.length);

                // Limpiar selecciones
                personasSeleccionadasSinRol = [];
                actualizarSelecciones();

                showNotification('Personas movidas a la lista de asignadas (localmente)', 'info');
            });

            // Botón "Quitar" - mover localmente (solo en la vista)
            $('#btnQuitar').on('click', function () {
                if (personasSeleccionadasConRol.length === 0) {
                    showNotification('Seleccione personas para quitar', 'warning');
                    return;
                }

                // Mover personas localmente
                personasSeleccionadasConRol.forEach(function (personaId) {
                    var persona = personasConRol.find(p => p.id === personaId);
                    if (persona) {
                        // Quitar de con rol
                        personasConRol = personasConRol.filter(p => p.id !== persona.id);
                        // Agregar a sin rol
                        personasSinRol.push(persona);
                    }
                });

                // Actualizar tablas
                renderizarTablaSinRol();
                renderizarTablaConRol();

                // Actualizar estadísticas
                $('#totalSinRol').text(personasSinRol.length);
                $('#totalConRol').text(personasConRol.length);
                $('#countSinRol').text(personasSinRol.length);
                $('#countConRol').text(personasConRol.length);

                // Limpiar selecciones
                personasSeleccionadasConRol = [];
                actualizarSelecciones();

                showNotification('Personas movidas a la lista de disponibles (localmente)', 'info');
            });

            // Botón "Asignar (BD)" - asignar inmediatamente en base de datos
            $('#btnAsignarInmediato').on('click', function () {
                if (personasSeleccionadasSinRol.length === 0) {
                    showNotification('Seleccione personas para asignar', 'warning');
                    return;
                }

                showConfirm(
                    'Confirmar Asignación',
                    '¿Está seguro de asignar el rol a ' + personasSeleccionadasSinRol.length + ' persona(s)? Esto actualizará inmediatamente la base de datos.',
                    function() {
                        asignarPersonasBD();
                        closeConfirm();
                    }
                );
            });

            // Botón "Quitar (BD)" - quitar inmediatamente en base de datos
            $('#btnQuitarInmediato').on('click', function () {
                if (personasSeleccionadasConRol.length === 0) {
                    showNotification('Seleccione personas para quitar', 'warning');
                    return;
                }

                showConfirm(
                    'Confirmar Eliminación',
                    '¿Está seguro de quitar el rol a ' + personasSeleccionadasConRol.length + ' persona(s)? Esto actualizará inmediatamente la base de datos.',
                    function() {
                        quitarPersonasBD();
                        closeConfirm();
                    }
                );
            });

            // Función para asignar personas en base de datos
            function asignarPersonasBD() {
                $.ajax({
                    url: '@Url.Action("AsignarRolAVariasPersonas", "ControladorRol")',
                    type: 'POST',
                    data: {
                        rolId: rolSeleccionadoId,
                        personasIds: personasSeleccionadasSinRol
                    },
                    beforeSend: function () {
                        $('#btnAsignarInmediato').prop('disabled', true)
                            .html('<i class="fas fa-spinner fa-spin me-1"></i>Asignando...');
                    },
                    success: function (response) {
                        if (response.success) {
                            showNotification('✅ ' + response.message + ' (' + response.asignados + ' asignados)', 'success');
                            // Recargar los datos actualizados
                            $('#btnCargarPersonas').click();
                        } else {
                            showNotification('❌ ' + response.message, 'danger');
                        }
                    },
                    error: function (xhr, status, error) {
                        showNotification('Error al conectar con el servidor: ' + error, 'danger');
                    },
                    complete: function () {
                        $('#btnAsignarInmediato').prop('disabled', false)
                            .html('<i class="fas fa-check me-1"></i>Asignar (BD)');
                    }
                });
            }

            // Función para quitar personas en base de datos
            function quitarPersonasBD() {
                $.ajax({
                    url: '@Url.Action("QuitarRolDeVariasPersonas", "ControladorRol")',
                    type: 'POST',
                    data: {
                        personasIds: personasSeleccionadasConRol
                    },
                    beforeSend: function () {
                        $('#btnQuitarInmediato').prop('disabled', true)
                            .html('<i class="fas fa-spinner fa-spin me-1"></i>Quitando...');
                    },
                    success: function (response) {
                        if (response.success) {
                            showNotification('✅ ' + response.message + ' (' + response.quitados + ' quitados)', 'success');
                            // Recargar los datos actualizados
                            $('#btnCargarPersonas').click();
                        } else {
                            showNotification('❌ ' + response.message, 'danger');
                        }
                    },
                    error: function (xhr, status, error) {
                        showNotification('Error al conectar con el servidor: ' + error, 'danger');
                    },
                    complete: function () {
                        $('#btnQuitarInmediato').prop('disabled', false)
                            .html('<i class="fas fa-times me-1"></i>Quitar (BD)');
                    }
                });
            }

            // Botón "Guardar" - persistir TODOS los cambios en base de datos
            $('#btnGuardar').on('click', function () {
                if (!rolSeleccionadoId) {
                    showNotification('No hay rol seleccionado para guardar asignaciones', 'warning');
                    return;
                }

                // Preparar IDs de personas con rol
                var personasConRolIds = personasConRol.map(p => p.id);

                showConfirm(
                    'Guardar Todos los Cambios',
                    '¿Está seguro de guardar todas las asignaciones actuales? Esto actualizará la base de datos con las ' + personasConRolIds.length + ' personas que actualmente tienen este rol.',
                    function() {
                        guardarTodosLosCambios(personasConRolIds);
                        closeConfirm();
                    }
                );
            });

            // Función para guardar todos los cambios
            function guardarTodosLosCambios(personasConRolIds) {
                // Nota: Para MongoDB, necesitamos hacerlo de manera diferente
                // Podemos usar una combinación de quitar a todos y luego asignar a los seleccionados
                // Primero, quitar el rol a todos los que lo tenían antes

                $.ajax({
                    url: '@Url.Action("QuitarRolDeVariasPersonas", "ControladorRol")',
                    type: 'POST',
                    data: {
                        personasIds: personasConRolIds
                    },
                    success: function(response) {
                        if (response.success) {
                            // Luego, asignar el rol a las personas seleccionadas
                            if (personasConRolIds.length > 0) {
                                $.ajax({
                                    url: '@Url.Action("AsignarRolAVariasPersonas", "ControladorRol")',
                                    type: 'POST',
                                    data: {
                                        rolId: rolSeleccionadoId,
                                        personasIds: personasConRolIds
                                    },
                                    success: function(response2) {
                                        if (response2.success) {
                                            showNotification('✅ Asignaciones guardadas correctamente. ' + response2.asignados + ' personas actualizadas.', 'success');
                                            // Recargar los datos actualizados
                                            $('#btnCargarPersonas').click();
                                        } else {
                                            showNotification('❌ ' + response2.message, 'danger');
                                        }
                                    },
                                    error: function() {
                                        showNotification('Error al guardar las asignaciones', 'danger');
                                    }
                                });
                            } else {
                                showNotification('✅ Asignaciones guardadas correctamente. Todas las personas fueron quitadas del rol.', 'success');
                                $('#btnCargarPersonas').click();
                            }
                        } else {
                            showNotification('❌ Error al procesar cambios: ' + response.message, 'danger');
                        }
                    },
                    error: function() {
                        showNotification('Error al conectar con el servidor', 'danger');
                    }
                });
            }

            // Botón "Limpiar" - resetear la selección
            $('#btnLimpiar').on('click', function () {
                showConfirm(
                    'Limpiar Selección',
                    '¿Está seguro de limpiar toda la selección? Esto descartará todos los cambios no guardados.',
                    function() {
                        $('#rolSelect').val('');
                        $('#infoPanel').hide();
                        $('#assignmentContainer').hide();
                        personasSinRol = [];
                        personasConRol = [];
                        personasSeleccionadasSinRol = [];
                        personasSeleccionadasConRol = [];
                        rolSeleccionadoId = '';
                        rolSeleccionadoCodigo = '';
                        showNotification('Selección limpiada correctamente', 'info');
                        closeConfirm();
                    }
                );
            });

            // Cerrar diálogo de confirmación con ESC
            $(document).keyup(function(e) {
                if (e.key === "Escape") {
                    closeConfirm();
                }
            });

            // Cerrar diálogo al hacer clic fuera
            $('#confirmDialog').click(function(e) {
                if (e.target === this) {
                    closeConfirm();
                }
            });
        });
    </script>
}