@{
    ViewBag.Title = "Administrar Roles";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var model = ViewBag.Roles as IEnumerable<object> ?? new List<object>();
}

<style>
    /* Ensure modals are above any page overlays/stacking contexts */
    .modal {
        z-index: 2000 !important;
    }

    .modal-backdrop {
        z-index: 1990 !important;
    }
</style>

<div class="container mt-3">
    <h3 class="mb-3"><i class="fas fa-user-tag me-2"></i>Administrar Roles</h3>

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="datalist">
                    <thead>
                        <tr>
                            <th style="width:30px"><input type="checkbox" id="selectAll" /></th>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Descripción</th>
                            <th>Usuarios Asignados</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (model != null && model.Any())
                        {
                            foreach (var item in model)
                            {
                                var id = item.GetType().GetProperty("XEROL_ID")?.GetValue(item)?.ToString() ?? "";
                                var nombre = item.GetType().GetProperty("XEROL_NOMBRE")?.GetValue(item)?.ToString() ?? "";
                                var descripcion = item.GetType().GetProperty("XEROL_DESCRI")?.GetValue(item)?.ToString() ?? "";
                                

                                <tr data-id="@id" data-nombre="@nombre" data-descripcion="@descripcion" >
                                    <td><input type="checkbox" class="row-select" /></td>
                                    <td>@id</td>
                                    <td>@nombre</td>
                                    <td>@(string.IsNullOrEmpty(descripcion) ? "Sin descripción" : descripcion)</td>
                                    <td>
                                        <span class="badge bg-info"></span>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr><td colspan="5">No hay registros de roles.</td></tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="mt-3 d-flex gap-2">
                <button id="createButton" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createModal">
                    <i class="fas fa-plus me-1"></i>Crear
                </button>

                <button id="viewButton" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#viewModal" disabled>
                    <i class="fas fa-eye me-1"></i>Ver
                </button>

                <button id="editButton" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editModal" disabled>
                    <i class="fas fa-edit me-1"></i>Editar
                </button>

                <button id="deleteButton" class="btn btn-danger" disabled>
                    <i class="fas fa-trash me-1"></i>Eliminar
                </button>

                <button id="assignButton" class="btn btn-warning" onclick="location.href='@Url.Action("AsignarRol", "ControladorRol")'">
                    <i class="fas fa-users me-1"></i>Asignar Usuarios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Modal -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            @using (Html.BeginForm("Crear", "ControladorRol", FormMethod.Post))
            {
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title" id="createModalLabel">Crear Nuevo Rol</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ID <span class="text-muted">(Generado automáticamente)</span></label>
                        <input type="text" name="XEROL_ID" class="form-control" required value="@ViewBag.NewRolId" readonly />
                        <small class="form-text text-muted">Formato: RO001, RO002, etc.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nombre del Rol <span class="text-danger">*</span></label>
                        <input type="text" name="XEROL_NOMBRE" class="form-control" required maxlength="30" />
                        <small class="form-text text-muted">Máximo 30 caracteres</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea name="XEROL_DESCRI" class="form-control" rows="3" maxlength="100"></textarea>
                        <small class="form-text text-muted">Máximo 100 caracteres</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="regenerateIdBtn" class="btn btn-outline-info">
                        <i class="fas fa-sync me-1"></i>Regenerar ID
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-1"></i>Guardar
                    </button>
                </div>
            }
        </div>
    </div>
</div>

<!-- View Modal -->
<div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles del Rol</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <dl class="row">
                    <dt class="col-sm-4">ID</dt>
                    <dd class="col-sm-8" id="view-id"></dd>

                    <dt class="col-sm-4">Nombre</dt>
                    <dd class="col-sm-8" id="view-nombre"></dd>

                    <dt class="col-sm-4">Descripción</dt>
                    <dd class="col-sm-8" id="view-descripcion"></dd>

                    <dt class="col-sm-4">Usuarios Asignados</dt>
                    <dd class="col-sm-8">
                        <span class="badge bg-info" id="view-usuarios">0</span>
                    </dd>
                </dl>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            @using (Html.BeginForm("Editar", "ControladorRol", FormMethod.Post))
            {
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title">Editar Rol</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="XEROL_ID" id="edit-id" />
                    <div class="mb-3">
                        <label class="form-label">Nombre del Rol <span class="text-danger">*</span></label>
                        <input type="text" name="XEROL_NOMBRE" id="edit-nombre" class="form-control" required maxlength="30" />
                        <small class="form-text text-muted">Máximo 30 caracteres</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea name="XEROL_DESCRI" id="edit-descripcion" class="form-control" rows="3" maxlength="100"></textarea>
                        <small class="form-text text-muted">Máximo 100 caracteres</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Guardar cambios
                    </button>
                </div>
            }
        </div>
    </div>
</div>

<!-- Delete Confirmation Form (posted by script) -->
@using (Html.BeginForm("Eliminar", "ControladorRol", FormMethod.Post, new { id = "deleteForm" }))
{
    @Html.AntiForgeryToken()
    <input type="hidden" name="id" id="delete-id" />
}

@section Scripts {
    <script>
        $(function () {
            // Move modals to body to avoid stacking-context issues from parent containers
            $('#createModal, #viewModal, #editModal').appendTo('body');

            function updateButtons() {
                var selected = $('#datalist tbody tr').has('input.row-select:checked');
                var count = selected.length;
                $('#viewButton').prop('disabled', count !== 1);
                $('#editButton').prop('disabled', count !== 1);
                $('#deleteButton').prop('disabled', count === 0);
            }

            // row click toggles checkbox
            $('#datalist tbody').on('click', 'tr', function (e) {
                if (e.target.type !== 'checkbox' && e.target.tagName !== 'A' && !$(e.target).closest('.btn').length) {
                    var cb = $(this).find('input.row-select');
                    cb.prop('checked', !cb.prop('checked'));
                }
                $(this).toggleClass('table-active', $(this).find('input.row-select').prop('checked'));
                updateButtons();
            });

            // checkbox click stops row click propagation
            $('#datalist').on('click', 'input.row-select', function (e) {
                e.stopPropagation();
                $(this).closest('tr').toggleClass('table-active', $(this).prop('checked'));
                updateButtons();
            });

            $('#selectAll').on('change', function () {
                var checked = $(this).prop('checked');
                $('input.row-select').prop('checked', checked).trigger('change');
            });

            // View / Edit populate modal fields from first selected row
            function getFirstSelectedData() {
                var row = $('#datalist tbody tr').has('input.row-select:checked').first();
                return {
                    id: row.data('id'),
                    nombre: row.data('nombre'),
                    descripcion: row.data('descripcion'),
                    usuarios: row.data('usuarios')
                };
            }

            $('#viewButton').on('click', function () {
                var d = getFirstSelectedData();
                $('#view-id').text(d.id);
                $('#view-nombre').text(d.nombre);
                $('#view-descripcion').text(d.descripcion || 'Sin descripción');
                $('#view-usuarios').text(d.usuarios);
            });

            $('#editButton').on('click', function () {
                var d = getFirstSelectedData();
                $('#edit-id').val(d.id);
                $('#edit-nombre').val(d.nombre);
                $('#edit-descripcion').val(d.descripcion);
            });

            $('#deleteButton').on('click', function () {
                var ids = [];
                var nombres = [];
                $('#datalist tbody tr').has('input.row-select:checked').each(function () {
                    ids.push($(this).data('id'));
                    nombres.push($(this).data('nombre'));
                });

                if (ids.length === 0) return;

                var message = '¿Está seguro que desea eliminar ';
                if (ids.length === 1) {
                    message += `el rol "${nombres[0]}" (${ids[0]})?`;
                } else {
                    message += `los ${ids.length} roles seleccionados?`;
                }
                message += '\n\n⚠️ Advertencia: No se pueden eliminar roles que tengan usuarios asignados.';

                if (!confirm(message)) return;

                if (ids.length === 1) {
                    // Eliminación individual
                    $('#delete-id').val(ids[0]);
                    $('#deleteForm').submit();
                } else {
                    // Eliminación múltiple (necesitarías crear una acción para esto)
                    alert('Para eliminar múltiples registros, contacte al administrador del sistema.');
                }
            });

            // Botón para regenerar ID en modal de creación
            $('#regenerateIdBtn').on('click', function () {
                $.ajax({
                    url: '@Url.Action("RegenerarId", "ControladorRol")',
                    type: 'POST',
                    success: function (response) {
                        if (response.success) {
                            $('input[name="XEROL_ID"]').val(response.nuevoId);
                        } else {
                            alert('Error al regenerar ID: ' + response.message);
                        }
                    },
                    error: function () {
                        alert('Error al conectar con el servidor');
                    }
                });
            });

            // Validación de formulario de creación
            $('form').on('submit', function () {
                var nombre = $('input[name="XEROL_NOMBRE"]').val();
                if (nombre && nombre.length > 30) {
                    alert('El nombre del rol no puede tener más de 30 caracteres');
                    return false;
                }

                var descripcion = $('textarea[name="XEROL_DESCRI"]').val();
                if (descripcion && descripcion.length > 100) {
                    alert('La descripción no puede tener más de 100 caracteres');
                    return false;
                }

                return true;
            });

            // Ensure backdrop z-index if created dynamically after show
            $(document).on('shown.bs.modal', '.modal', function () {
                $('.modal-backdrop').last().css('z-index', 1990);
            });

            // Mostrar mensajes de TempData
            @if (TempData["SuccessMessage"] != null)
            {
                <text>
                showToast('success', '@Html.Raw(TempData["SuccessMessage"])');
                </text>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <text>
                showToast('error', '@Html.Raw(TempData["ErrorMessage"])');
                </text>
            }

            function showToast(type, message) {
                // Implementar función para mostrar notificaciones (usando Toastr o similar)
                if (type === 'success') {
                    alert('✅ ' + message);
                } else {
                    alert('❌ ' + message);
                }
            }
        });
    </script>
}